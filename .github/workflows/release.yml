name: release

on:
  workflow_run:
    workflows: ["ci"]
    types: [completed]

permissions:
  contents: write

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  create-release:
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    runs-on: windows-latest

    steps:
      - name: Checkout target commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Determine semantic version
        id: semver
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          function Get-SemverTags {
            git tag --list | Where-Object { $_ -match '^v\d+\.\d+\.\d+$' }
          }

          function Convert-ToVersion([string]$tag) {
            [version]($tag.TrimStart('v'))
          }

          $semverTags = Get-SemverTags
          $latestTag = $null
          if ($semverTags.Count -gt 0) {
            $latestTag = $semverTags |
              Sort-Object { Convert-ToVersion $_ } -Descending |
              Select-Object -First 1
          }

          if ($latestTag) {
            $commitCount = [int](git rev-list --count "$latestTag..HEAD")
            $messages = git log --format=%B "$latestTag..HEAD"
            $baseVersion = Convert-ToVersion $latestTag
          } else {
            $commitCount = [int](git rev-list --count HEAD)
            $messages = git log --format=%B
            $baseVersion = [version]"0.0.0"
          }

          if ($commitCount -eq 0) {
            "should_release=false" >> $env:GITHUB_OUTPUT
            "version=${baseVersion}" >> $env:GITHUB_OUTPUT
            "tag=v$baseVersion" >> $env:GITHUB_OUTPUT
            exit 0
          }

          $bump = "patch"
          $allText = ($messages -join "`n")
          if ($allText -match 'BREAKING CHANGE' -or $allText -match '(?m)^[a-zA-Z]+(\([^)]+\))?!:') {
            $bump = "major"
          } elseif ($allText -match '(?m)^feat(\([^)]+\))?:') {
            $bump = "minor"
          } elseif ($allText -match '(?m)^fix(\([^)]+\))?:') {
            $bump = "patch"
          }

          $major = $baseVersion.Major
          $minor = $baseVersion.Minor
          $patch = $baseVersion.Build
          if ($patch -lt 0) { $patch = 0 }

          switch ($bump) {
            "major" { $major += 1; $minor = 0; $patch = 0 }
            "minor" { $minor += 1; $patch = 0 }
            default { $patch += 1 }
          }

          $version = "$major.$minor.$patch"
          $tag = "v$version"

          "should_release=true" >> $env:GITHUB_OUTPUT
          "bump=$bump" >> $env:GITHUB_OUTPUT
          "version=$version" >> $env:GITHUB_OUTPUT
          "tag=$tag" >> $env:GITHUB_OUTPUT

      - name: Package release artifacts
        if: steps.semver.outputs.should_release == 'true'
        shell: pwsh
        run: .\scripts\package.ps1 -Configuration Release -RuntimeIdentifiers win-x64,osx-x64,osx-arm64

      - name: Verify packaged ZIP files
        if: steps.semver.outputs.should_release == 'true'
        shell: pwsh
        run: |
          $files = Get-ChildItem -Path ".\artifacts\packages\*.zip" -File -ErrorAction SilentlyContinue
          if (-not $files -or $files.Count -eq 0) {
            throw "No ZIP files found under artifacts/packages."
          }
          $files | ForEach-Object { Write-Host "Found package: $($_.FullName)" }

      - name: Create GitHub Release
        if: steps.semver.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.semver.outputs.tag }}
          target_commitish: ${{ github.event.workflow_run.head_sha }}
          generate_release_notes: true
          fail_on_unmatched_files: true
          files: artifacts/packages/*.zip
